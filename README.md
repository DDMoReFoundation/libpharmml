# libPharmML

This is the version 0.3 of libPharmML. It provides a convenient
way to read and write PharmML (up to version 0.3) and it provides basic schema based
validation.


## Installation
### Prerequisites

* Java JDK 1.6 or newer
* Ant (tested with version 1.8.4)

The project has been tested and is known to work with versions 1.6 and 1.7
of the JDK. Build instructions for both environments are provided below.

### Setting up the project
If you are downloading this distribution from a git repository then
you need to first clone the project to your local machine. The remote
repository will typically tell you how to do this.

In the previous version, latest PharmML schema definitions were fetched from 
repository during the check-out process. This does not occur anymore as there
is no more class auto-generated by XSD files, and we want stable definition files.

#### Java 6

1. First go to the build directory

    cd libPharmML

2. Fetch all dependencies using Ivy.

    ant retrieve

3. Force Java 6 use the latest version of JAXB instead of the one it
comes with. This involves putting ivy_libs/src-build/jaxb-api.jar in
your JRE's endorsed directory. You might use something like

    cp ivy_libs/src-build/jaxb-api.jar $JAVA_HOME/jre/lib/endorsed/

4. Build the jars. This should download all dependencies and then
compile the code. You should end up with three jar files containing
the binary code, the javadoc of the API and the src code.

    ant jar-all

5. You may want to check that everything has been configured and built
correctly. In which case run the unit tests.

    ant run-tests

All tests should pass. If there is a problem then diagnostic messages
can be found in build/test_output/junitReports/index.html.

#### Java 7
1. Navigate to the libPharmML folder:
    cd libPharmML

2. Open the Ant script and change the values of the properties **source**
and **target** from 1.6 to 1.7.

3. Call the default ant target, jar-all:

    ant

4. As before, ensure that everything works by running the tests:

    ant run-tests
    
### Fetching libPharmML from Maven
libPharmML is available through the EBI Maven repository:
url: http://www.ebi.ac.uk/~maven/m2repo/
group: eu.ddmore.pharmml
module: libPharmml
version: 0.3

## Getting Started

The API should hopefully be intuitive. It can read a PharmML document,
write a DOM to a PharmML document, create a stub DOM and validate a
DOM. Some usage examples are contained in the contrib directory. Below
are code snippets showing the basic operations provided by the API.


### To get an instance of the API:

    ILibPharmML libPharmML = PharmMlFactory.getInstance().createLibPharmML();


### To read a DOM:

    InputStream in = new FileInputStream("examples/example3.xml")
    IPharmMLResource resource = libPharmML.createDomFromResource(in);
    in.close;
    PharmML dom = res.getDom();


### To write:

    IPharmMLResource resource = .....
    OutputStream os = new FileOutputStream(aFile);
    libPharmML.save(os, resource);
    os.close();

### To create:

    IPharmMLResource resource = libPharmML.createDom();
    PharmML dom = resource.getDom();

### To validate:

    IPharmMLResource resource = .....
    IPharmMLValidator validator = libPharmML.getValidator();
    IValidationReport rpt = validator.createValidationReport(resource);


## Implementation notes

The PharmML DOM is generated using JAXB (see https://jaxb.java.net/)
to convert the XML Schema into a set of Java classes. Each schema maps
to a separate java package. The XML Schema design uses the "Garden of
Eden" design pattern which means all elements have a simple of complex
type. JAXB creates classes for most types and some of the elements,
but often elements are defined by their type. For example to get the
content of a <Description> element you will use a class corresponding
to its type AnnotationType:

AnnotationType descn = anElement.getDescription();

Things get more complicated when we use substitution groups, which is
effectively a form of inheritance. In this case we need to use the
JAXBElement class, and then test what class to use. For example when
accessing an element of the substitution group Scalar we must do the
following to tech what was the 'inherited' class:
       
    JAXBElement<?> scalar = rhs.getScalar();
    if(scalar.getDeclaredType().equals(RealValueType.class)){
        RealValueType real = (RealValueType)scalar.getValue();
    }

Using this configuration of JAXB a choice (as defined by XML Schema)
must be determined by selecting all the possible options for null. For
example:

    Rhs rhs = lhs.getAssign();
    if(rhs.getEquation() != null){
        // do something with an equation
    }
    else if(rhs.getSymbRef() != null){
        // do something with a Symbref
    }


## Validation

Currently the library only validates against the XML Schema
definition. Addition rules such as type checking, checking for
duplicate symbols or dangling symbol references are not yet
checked.


## Acknowledgements

Thanks to Mihai Glont and Raza Ali from EBML-EBI for checking the
code and build and for their helpful feedback.

## Credits

Stuart Moodie.
Mihai Glont.
Florent Yvon.

9 Apr 2014.

Copyright EMBL-EBI 2014.


This code is licensed under Apache V2.0. See LICENSE for more details.
